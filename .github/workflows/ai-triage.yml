name: AI Triage (Caller)

on:
  workflow_run:
    workflows: ["CI Experiment"]
    types:
      - completed

permissions:
  pull-requests: write
  actions: read
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    outputs:
      pr_number: ${{ steps.pr.outputs.number }}
    steps:
      - name: Download PR Number Artifact
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          name: failure-evidence
          path: .
      - id: pr
        run: echo "number=$(cat pr_number.txt)" >> $GITHUB_OUTPUT

  call-triage-bot:
    needs: prepare
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    uses: openwisp/openwisp-utils/.github/workflows/reusable-ai-triage.yml@issues/524-ci-failure-bot
    with:
      pr_number: ${{ needs.prepare.outputs.pr_number }}
      head_sha: ${{ github.event.workflow_run.head_sha }}
      head_repo: ${{ github.event.workflow_run.head_repository.full_name }}
      run_id: ${{ github.event.workflow_run.id }}
    secrets:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      APP_ID: ${{ secrets.OPENWISP_BOT_APP_ID }}
      PRIVATE_KEY: ${{ secrets.OPENWISP_BOT_PRIVATE_KEY }}
